name: Deploy to Server

on:
  push:
    branches:
      - main  # æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT }}
          script: |
            set -e
            echo "ğŸš€ Starting deployment..."

            # è¿›å…¥é¡¹ç›®ç›®å½•
            cd /opt/new-api

            # æ‹‰å–æœ€æ–°ä»£ç 
            echo "ğŸ“¦ Pulling latest code from GitHub..."
            git pull origin main

            # åœæ­¢æœåŠ¡
            echo "â¸ï¸  Stopping services..."
            docker-compose down

            # é‡æ–°æ„å»ºå¹¶å¯åŠ¨
            echo "ğŸ”¨ Building and starting services..."
            docker-compose up -d --build

            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "â³ Waiting for services to start..."
            sleep 10

            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            echo "âœ… Checking service status..."
            docker-compose ps

            # æ£€æŸ¥å¥åº·çŠ¶æ€
            echo "ğŸ¥ Health check..."
            curl -f http://localhost:3000/api/status || echo "âš ï¸  Health check failed"

            echo "ğŸ‰ Deployment completed successfully!"

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… Deployment successful!"
          else
            echo "âŒ Deployment failed!"
          fi
